---
title: "Simulation SimRevisionR2"
author: "Yenny Webb-Vargas"
date: "Wednesday, September 17, 2014"
output: html_document
---

This implements simulation for testing my functional mediation function. 

Load the library 'refund'. It also loads the library 'fda' among many others.
```{r}
library(refund)
source('~/GitHub/functional_mediation/fMediation_ML.R')
```

Defining bootstrap function:
```{r fbootstrap}
fbootstrap_ML <- function(dta, index){
  dta = dta[index,]
  Y = dta[,"Y"]
  X = dta[,"X"]
  M = t(dta[,seq(2+1,ncol(dta))])
  
  result = fMediation_ML(X,Y,M,nbasis,norder,lambda=1e-8, boot=TRUE)
  return(result)
}
```

Load the canonical HRF function:
```{r}
short_HRF <- read.table("C:/Users/Yenny/Documents/GitHub/functional_mediation/YennyHRF")
plot(1:length(short_HRF), short_HRF, type="l")
```

Setting seed:
```{r}
seed = 794320
```


```{r}
sub=20
nbasis = 30
norder = 6

iters = 1
```

```{r}
Z = c(rep(0,20), short_HRF, rep(0,20))
```

```{r}
Pall  = matrix(0, iters, length(Z))
Pall2 = matrix(0, iters, length(Z))
Flag  = rep(0, iters)
A     = matrix(0, iters, length(Z))
B     = matrix(0, iters, length(Z))
C     = rep(0, iters)
c     = rep(0, iters)
```


```{r }
set.seed(seed)
X = rep(0,sub)
X[sample(1:sub)[1:(floor(sub/2))]] = 2
X = X - 1 

M = sapply(1:sub, function(i) rnorm(n = length(Z),mean=0, sd=1))
Y = X + rnorm(sub, mean=0, sd=1)

# I used this code to get data to check the fMediation_ML function, 
# it was causing problems with lambdas that are not very close to 
# zero:
#write.csv(cbind(Y,X,t(M)), file=paste0("sim_",seed, ".csv"))

dta  = cbind('Y'=Y,'X'=X,'M' =t(M))

out  = fMediation_ML(X,Y,M,nbasis,norder,lambda=1e-8)
stat = boot(data = dta, statistic = fbootstrap_ML,R = 100,sim = "ordinary",stype = "i") 


# Calculating p-value
Pall = 2*apply(cbind(colMeans(stat$t < 2*matrix(stat$t0, ncol=ncol(stat$t), nrow=nrow(stat$t), byrow = TRUE)),
                     colMeans(stat$t > 2*matrix(stat$t0, ncol=ncol(stat$t), nrow=nrow(stat$t), byrow = TRUE))),
               1, min)
Pall2 = 2*apply(cbind(colMeans(stat$t < matrix(stat$t0, ncol=ncol(stat$t), nrow=nrow(stat$t), byrow = TRUE)),
                      colMeans(stat$t > matrix(stat$t0, ncol=ncol(stat$t), nrow=nrow(stat$t), byrow = TRUE))),
               1, min)
A[i,] = out$afunction
B[i,] = out$bfunction
C(i)  = out$c
Cp(i) = out$cp
```

```{r}

```

